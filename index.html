<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Log In</title>
    <link rel="stylesheet" href="/css/style.css" />
  </head>
  <body>
    <div class="container">
      <div>
        <label>Username:</label>
        <input type="text" id="username" name="username" /><span
          id="username-message"
        ></span>
      </div>
      <div>
        <label>Password:</label>
        <input type="password" id="password" name="password" />
      </div>
      <div>
        <button id="login-btn">Log In</button>
        <button id="register-btn">Register</button>
        <button id="update-btn">Update User</button>
        <button id="delete-btn">Delete User</button>
      </div>
      <div>Current user: <span id="current-user"></span></div>
      <div>All users: <span id="all-users"></span></div>
    </div>
    <div id="notification"></div>
    <script>
      const loginBtn = document.getElementById("login-btn");
      const registerBtn = document.getElementById("register-btn");
      const updateBtn = document.getElementById("update-btn");
      const deleteBtn = document.getElementById("delete-btn");
      const notification = document.getElementById("notification");
      const usernameMessage = document.getElementById("username-message");

      function getBody() {
        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;
        return { username, password };
      }

      //generic function to fetch data from the server
      function fetchData(url, body, method = "POST") {
        return fetch(url, {
          method, // Use the method passed, default is POST
          headers: {
            "Content-Type": "application/json;charset=UTF-8",
          },
          body: JSON.stringify(body),
        });
      }

      //fetch users data from the server
      async function fetchUsers() {
        const response = await fetch("http://localhost:8080/users");
        const data = await response.json();
        const allUsers = document.getElementById("all-users");
        allUsers.innerText = data.users.map((user) => user).join(", ");

        console.log(data);
      }

      fetchUsers();

      //login button event listener
      loginBtn.addEventListener("click", async () => {
        const body = getBody();
        const response = await fetchData("http://localhost:8080/login", body);
        const data = await response.json();
        const currentUser = document.getElementById("current-user");

        if (response.ok) {
          currentUser.innerText = data.username;
          notification.innerText =
            "Login successful! Redirecting to the website in 3 seconds...";
          notification.style.display = "block";
          setTimeout(() => {
            window.location.href = "/website";
          }, 3000);
        } else {
          currentUser.innerText = "";
          notification.innerText = data.error;
          notification.style.display = "block";
          setTimeout(() => {
            notification.style.display = "none";
          }, 3000);
        }
      });

      //register button event listener
      registerBtn.addEventListener("click", async () => {
        const body = getBody();

        try {
          const response = await fetchData(
            "http://localhost:8080/register",
            body
          );

          if (response.ok) {
            const data = await response.json();
            usernameMessage.innerText = data.message;
            fetchUsers(); // 更新用户列表
          } else {
            const errorData = await response.json();
            usernameMessage.innerText = errorData.error;
          }
        } catch (error) {
          console.error("Network or server error", error);
        }
      });

      // 更新按钮事件监听
      updateBtn.addEventListener("click", async () => {
        const newUsername = prompt("Enter new username:");
        const newPassword = prompt("Enter new password:");

        if (!newUsername && !newPassword) {
          alert("At least one field is required to update.");
          return;
        }

        const currentUsername = document.getElementById("username").value;
        const password = document.getElementById("password").value; // 获取当前密码
        const body = { password, newUsername, newPassword }; // 添加当前密码以验证
        const response = await fetchData(
          `http://localhost:8080/users/${currentUsername}`,
          body,
          "PUT"
        ); // 直接传递 username

        const data = await response.json();
        notification.innerText = data.message || data.error;
        notification.style.display = "block";
        fetchUsers(); // 更新用户列表
      });

      //delete button event listener
      deleteBtn.addEventListener("click", async () => {
        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;

        if (!username || !password) {
          alert("Both username and password are required.");
          return;
        }

        const body = { password }; // Only send the password for verification
        const response = await fetchData(
          `http://localhost:8080/users/${username}`,
          body,
          "DELETE" // Use DELETE method
        );

        const data = await response.json();
        notification.innerText = data.message || data.error;
        notification.style.display = "block";
        currentUsername.innerText = "";
        fetchUsers(); // Update the list of users
      });
    </script>
  </body>
</html>
