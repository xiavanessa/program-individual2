<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Log In</title>
    <link rel="stylesheet" href="/css/style.css" />
  </head>
  <body>
    <div class="container">
      <div>
        <label>Username:</label>
        <input type="text" id="username" name="username" /><span
          id="username-message"
        ></span>
      </div>
      <div>
        <label>Password:</label>
        <input type="password" id="password" name="password" />
      </div>
      <div>
        <button id="login-btn">Log In</button>
        <button id="register-btn">Register</button>
        <button id="update-btn">Update User</button>
        <button id="delete-btn">Delete User</button>
      </div>
      <div>Current user: <span id="current-user"></span></div>
      <div>All users: <span id="all-users"></span></div>
    </div>
    <div id="notification"></div>
    <script>
      // const loginBtn = document.getElementById("login-btn");
      // const registerBtn = document.getElementById("register-btn");
      // const updateBtn = document.getElementById("update-btn");
      // const deleteBtn = document.getElementById("delete-btn");
      // const notification = document.getElementById("notification");
      // const usernameMessage = document.getElementById("username-message");
      // const allUsers = document.getElementById("all-users");
      // const currentUser = document.getElementById("current-user");

      // function getBody() {
      //   const username = document.getElementById("username").value;
      //   const password = document.getElementById("password").value;
      //   return { username, password };
      // }

      // function clearInputFields() {
      //   document.getElementById("username").value = "";
      //   document.getElementById("password").value = "";
      // }

      // //generic function to fetch data from the server
      // function fetchData(url, body, method = "POST") {
      //   return fetch(`http://localhost:8080${url}`, {
      //     method, // Use the method passed, default is POST
      //     headers: {
      //       "Content-Type": "application/json;charset=UTF-8",
      //     },
      //     body: JSON.stringify(body),
      //   });
      // }

      // //fetch users data from the server
      // async function fetchUsers() {
      //   const response = await fetch("http://localhost:8080/users");
      //   const data = await response.json();
      //   allUsers.innerText = data.users.map((user) => user).join(", ");

      //   console.log(data);
      // }

      // fetchUsers();

      // //login button event listener
      // loginBtn.addEventListener("click", async () => {
      //   const body = getBody();
      //   const response = await fetchData("/login", body);
      //   const data = await response.json();

      //   if (response.ok) {
      //     currentUser.innerText = data.username;
      //     notification.innerText =
      //       "Login successful! Redirecting to the website in 3 seconds...";
      //     notification.style.display = "block";
      //     setTimeout(() => {
      //       window.location.href = "/website";
      //     }, 3000);
      //   } else {
      //     currentUser.innerText = "";
      //     notification.innerText = data.error;
      //     notification.style.display = "block";
      //     setTimeout(() => {
      //       notification.style.display = "none";
      //     }, 3000);
      //   }
      // });

      // //register button event listener
      // registerBtn.addEventListener("click", async () => {
      //   const body = getBody();

      //   try {
      //     const response = await fetchData("/register", body);
      //     const data = await response.json();

      //     if (response.ok) {
      //       notification.innerText = data.message;
      //       notification.style.display = "block";
      //       fetchUsers();
      //     } else {
      //       notification.innerText = data.error;
      //       notification.style.display = "block";
      //     }
      //   } catch (error) {
      //     console.error("Network or server error", error);
      //   }
      // });

      // // update button event listener
      // updateBtn.addEventListener("click", async () => {
      //   const newUsername = prompt("Enter new username:");
      //   const newPassword = prompt("Enter new password:");
      //   const currentUsername = document.getElementById("username").value;
      //   const password = document.getElementById("password").value;

      //   if (!newUsername && !newPassword) {
      //     alert("At least one field is required to update.");
      //     return;
      //   }

      //   const body = { password, newUsername, newPassword };
      //   const response = await fetchData(
      //     `/users/${currentUsername}`,
      //     body,
      //     "PUT"
      //   );

      //   const data = await response.json();
      //   notification.innerText = data.message || data.error;
      //   notification.style.display = "block";
      //   allUsers.innerText = "";
      //   fetchUsers();
      // });

      // // delete button event listener
      // deleteBtn.addEventListener("click", async () => {
      //   const currentUsername = document.getElementById("username").value;
      //   const password = document.getElementById("password").value;

      //   const body = { password };

      //   try {
      //     // send a DELETE request to the server
      //     const response = await fetchData(
      //       `/users/${currentUsername}`,
      //       body,
      //       "DELETE"
      //     );

      //     if (response.ok) {
      //       const data = await response.json();
      //       usernameMessage.innerText = data.message;
      //       clearInputFields();
      //       fetchUsers();
      //     } else {
      //       const errorData = await response.json();
      //       usernameMessage.innerText = errorData.error;
      //     }
      //   } catch (error) {
      //     console.error("Network or server error", error);
      //   }
      // });

      document.addEventListener("DOMContentLoaded", () => {
        // Cache DOM elements
        const loginBtn = document.getElementById("login-btn");
        const registerBtn = document.getElementById("register-btn");
        const updateBtn = document.getElementById("update-btn");
        const deleteBtn = document.getElementById("delete-btn");
        const notification = document.getElementById("notification");
        const usernameMessage = document.getElementById("username-message");
        const allUsers = document.getElementById("all-users");
        const currentUser = document.getElementById("current-user");

        // Utility Functions
        function getBody() {
          const username = document.getElementById("username").value;
          const password = document.getElementById("password").value;
          return { username, password };
        }

        function clearInputFields() {
          document.getElementById("username").value = "";
          document.getElementById("password").value = "";
        }

        async function fetchData(url, body = null, method = "POST") {
          try {
            const response = await fetch(`http://localhost:8080${url}`, {
              method,
              headers: {
                "Content-Type": "application/json;charset=UTF-8",
              },
              body: body ? JSON.stringify(body) : null,
            });

            if (!response.ok) {
              throw new Error(`HTTP error! Status: ${response.status}`);
            }

            return await response.json();
          } catch (error) {
            console.error("Fetch error:", error);
            notification.innerText =
              "Network or server error. Please try again later.";
            notification.style.display = "block";
            throw error; // Rethrow to let the calling function handle it
          }
        }

        async function fetchUsers() {
          try {
            const data = await fetchData("/users", null, "GET");
            allUsers.innerText = data.users.join(", ");
          } catch (error) {
            allUsers.innerText = "Error fetching users.";
          }
        }

        function displayNotification(message, duration = 3000) {
          notification.innerText = message;
          notification.style.display = "block";
          setTimeout(() => {
            notification.style.display = "none";
          }, duration);
        }

        // Event Listeners
        loginBtn.addEventListener("click", async () => {
          try {
            const body = getBody();
            const data = await fetchData("/login", body);

            currentUser.innerText = data.username || "";
            displayNotification(
              "Login successful! Redirecting to the website in 3 seconds..."
            );
            setTimeout(() => {
              window.location.href = "/website";
            }, 3000);
          } catch (error) {
            currentUser.innerText = "";
            displayNotification(
              "Login failed: " + (error.message || "Unknown error")
            );
          }
        });

        registerBtn.addEventListener("click", async () => {
          try {
            const body = getBody();
            const data = await fetchData("/register", body);

            displayNotification(data.message || "Registration successful!");
            fetchUsers();
          } catch (error) {
            displayNotification(
              "Registration failed: " + (error.message || "Unknown error")
            );
          }
        });

        updateBtn.addEventListener("click", async () => {
          const newUsername = prompt("Enter new username:") || "";
          const newPassword = prompt("Enter new password:") || "";
          const currentUsername = document.getElementById("username").value;
          const password = document.getElementById("password").value;

          if (!newUsername && !newPassword) {
            alert("At least one field is required to update.");
            return;
          }

          try {
            const body = { password, newUsername, newPassword };
            const data = await fetchData(
              `/users/${currentUsername}`,
              body,
              "PUT"
            );
            displayNotification(data.message || "User updated successfully!");
            fetchUsers();
          } catch (error) {
            displayNotification(
              "Update failed: " + (error.message || "Unknown error")
            );
          }
        });

        deleteBtn.addEventListener("click", async () => {
          const currentUsername = document.getElementById("username").value;
          const password = document.getElementById("password").value;

          try {
            const body = { password };
            const data = await fetchData(
              `/users/${currentUsername}`,
              body,
              "DELETE"
            );
            usernameMessage.innerText =
              data.message || "User deleted successfully!";
            clearInputFields();
            fetchUsers();
          } catch (error) {
            usernameMessage.innerText =
              "Deletion failed: " + (error.message || "Unknown error");
          }
        });

        // Initial fetch
        fetchUsers();
      });
    </script>
  </body>
</html>
